<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Spreadsheet Splitter (Login Protected)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS library for reading/writing Excel files -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    /* Simple spinner animation */
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 4px solid #ffffff;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

  <!-- Top bar (shows only when authed) -->
  <header id="topbar" class="hidden border-b border-gray-800/60">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="text-sm text-gray-400">
        <span class="font-semibold text-cyan-400">Spreadsheet Splitter</span>
        <span class="mx-2 text-gray-600">‚Ä¢</span>
        <span id="login-status" class="text-gray-400">Logged in</span>
      </div>
      <button id="logout-btn" class="text-sm font-medium px-3 py-1.5 rounded-md bg-gray-800 hover:bg-gray-700 text-gray-200">
        Log out
      </button>
    </div>
  </header>

  <!-- LOGIN SCREEN -->
  <main id="login-screen" class="flex items-center justify-center min-h-[80vh] p-4">
    <div class="w-full max-w-md bg-gray-800 rounded-2xl shadow-2xl p-8 space-y-6">
      <div class="text-center">
        <h1 class="text-3xl font-bold text-cyan-400">Sign in</h1>
        <p class="text-gray-400 mt-2">Access the Spreadsheet Splitter</p>
      </div>

      <form id="login-form" class="space-y-4" autocomplete="off">
        <div>
          <label for="username" class="block text-sm font-medium text-gray-300">Username</label>
          <input id="username" name="username" type="text" required
                 class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-cyan-500 focus:border-cyan-500 sm:text-sm text-white p-2"
                 placeholder="Enter username"/>
        </div>

        <div>
          <label for="password" class="block text-sm font-medium text-gray-300">Password</label>
          <div class="relative">
            <input id="password" name="password" type="password" required
                   class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-cyan-500 focus:border-cyan-500 sm:text-sm text-white p-2 pr-10"
                   placeholder="Enter password"/>
            <button type="button" id="toggle-pass"
                    class="absolute inset-y-0 right-0 px-3 text-gray-400 hover:text-gray-200"
                    aria-label="Show password">
              üëÅÔ∏è
            </button>
          </div>
        </div>

        <button id="login-btn" type="submit"
                class="w-full flex justify-center items-center gap-2 py-2.5 px-4 rounded-md text-sm font-medium text-white bg-cyan-600 hover:bg-cyan-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-cyan-500">
          Sign in
        </button>

        <p id="login-error" class="text-sm text-red-400 hidden">Invalid username or password.</p>

        <div class="text-xs text-gray-500 pt-2">
          <div><strong>Demo credentials</strong></div>
          <div>username: <code class="text-gray-400">asdf</code></div>
          <div>password: <code class="text-gray-400">2026</code></div>
        </div>
      </form>
    </div>
  </main>

  <!-- APP SCREEN (hidden until logged in) -->
  <section id="app" class="hidden">
    <div class="flex items-center justify-center min-h-[80vh] p-4">
      <div class="w-full max-w-2xl bg-gray-800 rounded-2xl shadow-2xl p-8 space-y-6">
        <!-- Header -->
        <div class="text-center">
          <h1 class="text-3xl font-bold text-cyan-400">Spreadsheet Splitter</h1>
          <p class="text-gray-400 mt-2">Upload an Excel file to split it into multiple sheets based on a column value.</p>
        </div>

        <!-- File Upload -->
        <div>
          <label for="file-upload" class="block text-sm font-medium text-gray-300 mb-2">1. Upload your XLS or XLSX file</label>
          <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-600 border-dashed rounded-md">
            <div class="space-y-1 text-center">
              <svg class="mx-auto h-12 w-12 text-gray-500" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <div class="flex text-sm text-gray-400">
                <label for="file-upload" class="relative cursor-pointer bg-gray-700 rounded-md font-medium text-cyan-400 hover:text-cyan-300 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-offset-gray-800 focus-within:ring-cyan-500 px-2">
                  <span>Select a file</span>
                  <input id="file-upload" name="file-upload" type="file" class="sr-only" accept=".xlsx, .xls">
                </label>
                <p class="pl-1">or drag and drop</p>
              </div>
              <p id="file-name" class="text-xs text-gray-500">XLSX or XLS up to 50MB</p>
            </div>
          </div>
        </div>

        <!-- Configuration -->
        <div class="space-y-4">
          <h2 class="text-lg font-semibold text-gray-200">2. Configure Settings</h2>
          <div>
            <label for="split-column" class="block text-sm font-medium text-gray-300">Column Name to Split By</label>
            <input type="text" name="split-column" id="split-column" value="RevenueVillageName"
                   class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-cyan-500 focus:border-cyan-500 sm:text-sm text-white p-2">
          </div>
          <div class="flex items-start pt-1">
            <div class="flex items-center h-5">
              <input id="skip-blank" name="skip-blank" type="checkbox" checked
                     class="focus:ring-cyan-500 h-4 w-4 text-cyan-600 border-gray-500 rounded bg-gray-700">
            </div>
            <div class="ml-3 text-sm">
              <label for="skip-blank" class="font-medium text-gray-300">Skip rows with blank value in split column</label>
            </div>
          </div>
        </div>

        <!-- Action Button -->
        <div>
          <button id="process-btn"
                  class="w-full flex justify-center items-center gap-3 py-3 px-4 rounded-md text-sm font-medium text-white bg-cyan-600 hover:bg-cyan-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-cyan-500 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
            <span id="btn-text">Split File</span>
            <div id="btn-spinner" class="spinner hidden"></div>
          </button>
        </div>

        <!-- Status & Download -->
        <div id="status-container" class="text-center p-4 bg-gray-700 rounded-md hidden">
          <p id="status-message" class="text-gray-300"></p>
          <a id="download-link" class="mt-2 inline-block text-cyan-400 font-semibold hover:underline hidden">Download Processed File</a>
        </div>
      </div>
    </div>
  </section>

  <script>
    /* =========================
       AUTH / LOGIN HANDLING
       ========================= */
    const LOGIN_KEY = 'splitter_authed_v1';
    const VALID_USER = 'asdf';
    const VALID_PASS = '2026';

    const loginScreen = document.getElementById('login-screen');
    const loginForm   = document.getElementById('login-form');
    const loginError  = document.getElementById('login-error');
    const togglePass  = document.getElementById('toggle-pass');
    const passwordInp = document.getElementById('password');
    const usernameInp = document.getElementById('username');
    const loginBtn    = document.getElementById('login-btn');

    const appSection  = document.getElementById('app');
    const topbar      = document.getElementById('topbar');
    const logoutBtn   = document.getElementById('logout-btn');

    function isAuthed() {
      try { return localStorage.getItem(LOGIN_KEY) === '1'; } catch (_) { return false; }
    }

    function showApp() {
      loginScreen.classList.add('hidden');
      topbar.classList.remove('hidden');
      appSection.classList.remove('hidden');
    }
    function showLogin() {
      appSection.classList.add('hidden');
      topbar.classList.add('hidden');
      loginScreen.classList.remove('hidden');
      loginError.classList.add('hidden');
      loginForm.reset();
      usernameInp.focus();
    }

    // Load initial view
    document.addEventListener('DOMContentLoaded', () => {
      if (isAuthed()) showApp(); else showLogin();
    });

    // Password show/hide
    togglePass.addEventListener('click', () => {
      const type = passwordInp.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInp.setAttribute('type', type);
    });

    // Handle login
    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      loginError.classList.add('hidden');

      const u = usernameInp.value.trim();
      const p = passwordInp.value;

      // Hard-coded check
      if (u === VALID_USER && p === VALID_PASS) {
        try { localStorage.setItem(LOGIN_KEY, '1'); } catch (_) {}
        showApp();
      } else {
        loginError.classList.remove('hidden');
      }
    });

    // Logout
    logoutBtn.addEventListener('click', () => {
      try { localStorage.removeItem(LOGIN_KEY); } catch (_) {}
      showLogin();
    });

    /* =======================================
       SPREADSHEET SPLITTER (existing logic)
       ======================================= */
    // --- DOM Element References ---
    const fileUpload = document.getElementById('file-upload');
    const fileNameDisplay = document.getElementById('file-name');
    const splitColumnInput = document.getElementById('split-column');
    const skipBlankCheckbox = document.getElementById('skip-blank');
    const processBtn = document.getElementById('process-btn');
    const btnText = document.getElementById('btn-text');
    const btnSpinner = document.getElementById('btn-spinner');
    const statusContainer = document.getElementById('status-container');
    const statusMessage = document.getElementById('status-message');
    const downloadLink = document.getElementById('download-link');

    let uploadedFile = null;

    // --- Event Listeners ---
    if (fileUpload) {
      fileUpload.addEventListener('change', (event) => {
        uploadedFile = event.target.files[0];
        if (uploadedFile) {
          fileNameDisplay.textContent = uploadedFile.name;
          fileNameDisplay.classList.remove('text-gray-500');
          fileNameDisplay.classList.add('text-green-400');
        } else {
          fileNameDisplay.textContent = 'XLSX or XLS up to 50MB';
          fileNameDisplay.classList.add('text-gray-500');
          fileNameDisplay.classList.remove('text-green-400');
        }
      });
    }

    if (processBtn) processBtn.addEventListener('click', handleFileProcessing);

    // --- Core Logic ---
    async function handleFileProcessing() {
      if (!isAuthed()) {
        updateStatus('Please log in to use the splitter.', 'error');
        return;
      }

      if (!uploadedFile) {
        updateStatus('Please select a file first.', 'error');
        return;
      }

      setLoading(true);
      updateStatus('Reading file...', 'info');

      // Using a timeout to allow the UI to update before the heavy processing starts
      setTimeout(() => {
        try {
          const reader = new FileReader();
          reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });

            // Use the first sheet as the source
            const sourceSheetName = workbook.SheetNames[0];
            if (!sourceSheetName) {
              throw new Error('No sheets found in the workbook.');
            }
            const ws = workbook.Sheets[sourceSheetName];

            splitSheetData(ws);
          };
          reader.onerror = function() {
            throw new Error('Error reading the file.');
          }
          reader.readAsArrayBuffer(uploadedFile);
        } catch (error) {
          console.error(error);
          updateStatus(`An error occurred: ${error.message}`, 'error');
          setLoading(false);
        }
      }, 100);
    }

    function splitSheetData(ws) {
      updateStatus('Processing data...', 'info');

      // --- Get Configuration from UI ---
      const splitColumnName = splitColumnInput.value.trim();
      if (!splitColumnName) {
        throw new Error('Please enter a column name to split by.');
      }

      const CONFIG = {
        HEADER_ROW: 1, // Header is assumed to be on the first row
        TARGET_PREFIX: "", // No prefix is used
        SKIP_BLANK_VILLAGE: skipBlankCheckbox.checked,
        MAX_SHEET_NAME_LEN: 31 // Excel's sheet name limit
      };

      // Convert sheet to array of arrays (aoa)
      const data = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });

      if (data.length < CONFIG.HEADER_ROW) {
        throw new Error('Header row not found. Check configuration.');
      }

      const headerRowIndex = CONFIG.HEADER_ROW - 1;
      const headers = data[headerRowIndex].map(v => String(v || '').trim());

      // Find the key column using user input
      const rvColIndex = findHeaderIndexFuzzy(headers, [splitColumnName]);

      if (rvColIndex === -1) {
        throw new Error(`Could not find the "${splitColumnName}" column. Check the header text.`);
      }

      const rows = data.slice(CONFIG.HEADER_ROW);

      // Group rows by the value in the specified column
      const map = new Map();
      for (const row of rows) {
        // Ensure row has enough columns to prevent errors
        if (row.length <= rvColIndex) continue;

        const raw = String(row[rvColIndex] ?? '').trim();
        if (!raw && CONFIG.SKIP_BLANK_VILLAGE) continue;
        const key = raw || '(blank)';
        if (!map.has(key)) map.set(key, []);
        map.get(key).push(row);
      }

      if (map.size === 0) {
        throw new Error(`No unique values found in column "${splitColumnName}" to split by.`);
      }

      // --- Create a new workbook and add new sheets ---
      updateStatus(`Found ${map.size} unique values. Creating new sheets...`, 'info');
      const newWorkbook = XLSX.utils.book_new();
      const headerRowData = data[headerRowIndex];
      const existingNames = new Set();

      for (const [groupKey, groupRows] of map.entries()) {
        let targetName = toSafeSheetName(groupKey, 31);
        targetName = uniquifyName(targetName, existingNames, 31);
        existingNames.add(targetName);

        const outData = [headerRowData, ...groupRows];
        const newSheet = XLSX.utils.aoa_to_sheet(outData);

        // Add auto-filter
        if (newSheet['!ref']) {
          newSheet['!autofilter'] = { ref: newSheet['!ref'] };
        }

        XLSX.utils.book_append_sheet(newWorkbook, newSheet, targetName);
      }

      // --- Generate and offer download ---
      generateDownload(newWorkbook);
      setLoading(false);
    }

    function generateDownload(workbook) {
      updateStatus(`Success! Created ${workbook.SheetNames.length} sheets.`, 'success');
      const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
      const blob = new Blob([wbout], { type: 'application/octet-stream' });

      const url = URL.createObjectURL(blob);
      downloadLink.href = url;
      const originalFilename = uploadedFile.name.split('.').slice(0, -1).join('.');
      downloadLink.download = `${originalFilename}_split.xlsx`;
      downloadLink.classList.remove('hidden');

      // Clean up the object URL after a delay
      setTimeout(() => URL.revokeObjectURL(url), 60000);
    }

    // --- Helper Functions ---
    /** Fuzzy find: exact, case-insensitive, tries variants without spaces/underscores/punctuation. */
    function findHeaderIndexFuzzy(headers, namesToTry) {
      const normalizedHeaders = headers.map(h => h.toLowerCase().replace(/[\s_.-]+/g, ''));
      for (const name of namesToTry) {
        const normalizedName = name.toLowerCase().replace(/[\s_.-]+/g, '');
        const index = normalizedHeaders.indexOf(normalizedName);
        if (index !== -1) return index;
      }
      return -1;
    }

    /** Sanitizes a string to be a valid sheet name. */
    function toSafeSheetName(name, maxLength) {
      let safe = String(name).replace(/[:\\/?*[\]]/g, '_'); // Replace invalid characters
      safe = safe.trim();
      if (safe.length > maxLength) safe = safe.substring(0, maxLength);
      if (!safe) safe = 'Sheet';
      return safe;
    }

    /** Ensures a sheet name is unique within the workbook. */
    function uniquifyName(name, existingNames, maxLength) {
      if (!existingNames.has(name)) return name;
      let i = 1;
      const base = name.substring(0, Math.max(1, maxLength - 4)); // leave space for ' (X)'
      let uniqueName = name;
      do {
        uniqueName = `${base} (${i++})`;
        if (uniqueName.length > maxLength) uniqueName = uniqueName.substring(0, maxLength);
      } while (existingNames.has(uniqueName));
      return uniqueName;
    }

    // --- UI State Management ---
    function setLoading(isLoading) {
      if (!processBtn) return;
      processBtn.disabled = isLoading;
      if (isLoading) {
        btnText.classList.add('hidden');
        btnSpinner.classList.remove('hidden');
      } else {
        btnText.classList.remove('hidden');
        btnSpinner.classList.add('hidden');
      }
    }

    function updateStatus(message, type = 'info') {
      statusContainer.classList.remove('hidden');
      statusMessage.textContent = message;

      statusMessage.classList.remove('text-green-400', 'text-red-400', 'text-gray-300');
      downloadLink.classList.add('hidden');

      if (type === 'success') {
        statusMessage.classList.add('text-green-400');
      } else if (type === 'error') {
        statusMessage.classList.add('text-red-400');
      } else {
        statusMessage.classList.add('text-gray-300');
      }
    }
  </script>
</body>
</html>
